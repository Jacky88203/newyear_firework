<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 è·¨å¹´æ„Ÿåº”çƒŸèŠ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; color: white; font-family: sans-serif; }
        canvas { position: absolute; top: 0; left: 0; }
        #video-preview { position: fixed; bottom: 20px; right: 20px; width: 100px; height: 75px; border: 2px solid rgba(255,255,255,0.5); border-radius: 10px; z-index: 100; transform: scaleX(-1); }
        #ui { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; z-index: 200; }
        #countdown { font-size: 8rem; font-weight: bold; background: linear-gradient(to bottom, #fff, #ffd700); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: none; }
        #msg { position: fixed; bottom: 120px; width: 100%; text-align: center; font-size: 14px; opacity: 0.7; }
        /* 3D å®¹å™¨ */
        #three-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    </style>
</head>
<body>

<canvas id="fireworkCanvas"></canvas>
<div id="three-container"></div>
<video id="input_video" style="display:none"></video>
<canvas id="video-preview"></canvas>

<div id="ui">
    <div id="countdown">3</div>
</div>

<div id="msg">âœ‹ å¼ å¼€æ‰‹æŒå€’æ•°å¼•çˆ† | ğŸ™†â€â™‚ï¸ åŒæ‰‹æ¯”å¿ƒè§¦å‘å›å¿†</div>

<script>
// --- 1. å£°éŸ³å¼•æ“ (Web Audio API) ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playExplosionSound() {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(150, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
    gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.5);
}

// --- 2. çƒŸèŠ±ç²’å­ç³»ç»Ÿ ---
const fwCanvas = document.getElementById('fireworkCanvas');
const ctx = fwCanvas.getContext('2d');
let particles = [];
fwCanvas.width = window.innerWidth;
fwCanvas.height = window.innerHeight;

class Particle {
    constructor(x, y, color) {
        this.x = x; this.y = y; this.color = color;
        this.vel = { x: (Math.random()-0.5)*10, y: (Math.random()-0.5)*10 };
        this.alpha = 1; this.friction = 0.95; this.gravity = 0.2;
    }
    draw() {
        ctx.globalAlpha = this.alpha;
        ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI*2);
        ctx.fillStyle = this.color; ctx.fill();
    }
    update() {
        this.vel.x *= this.friction; this.vel.y *= this.friction;
        this.vel.y += this.gravity;
        this.x += this.vel.x; this.y += this.vel.y;
        this.alpha -= 0.01;
    }
}

function createFirework(x, y) {
    playExplosionSound();
    const colors = ['#ff0043', '#14ffeb', '#ffbe00', '#ff00ff', '#ffffff'];
    const color = colors[Math.floor(Math.random()*colors.length)];
    for(let i=0; i<80; i++) particles.push(new Particle(x, y, color));
}

// --- 3. Three.js éšè—å½©è›‹ (æ—‹è½¬ç…§ç‰‡å¢™) ---
const tScene = new THREE.Scene();
const tCamera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const tRenderer = new THREE.WebGLRenderer({ alpha: true });
tRenderer.setSize(window.innerWidth, window.innerHeight);
document.getElementById('three-container').appendChild(tRenderer.domElement);

let photoGroup = new THREE.Group();
tScene.add(photoGroup);
tCamera.position.z = 5;

// åˆ›å»ºè™šæ‹Ÿç…§ç‰‡å—
for(let i=0; i<8; i++) {
    const geo = new THREE.PlaneGeometry(1.5, 1);
    const mat = new THREE.MeshBasicMaterial({ 
        color: 0xffffff, side: THREE.DoubleSide, transparent: true, opacity: 0 
    });
    const mesh = new THREE.Mesh(geo, mat);
    const angle = (i / 8) * Math.PI * 2;
    mesh.position.set(Math.cos(angle)*3, 1, Math.sin(angle)*3);
    mesh.rotation.y = -angle;
    photoGroup.add(mesh);
}

function triggerHeartMemory() {
    photoGroup.children.forEach(m => m.material.opacity = 0.8);
    photoGroup.rotation.y += 0.02; // å¼€å§‹æ—‹è½¬
}

// --- 4. æ‰‹åŠ¿é€»è¾‘æ§åˆ¶ ---
let count = 3;
let isCounting = false;
const cdEl = document.getElementById('countdown');

function startSequence() {
    if(isCounting) return;
    isCounting = true;
    cdEl.style.display = 'block';
    let timer = setInterval(() => {
        cdEl.innerText = count;
        if(count <= 0) {
            clearInterval(timer);
            cdEl.innerText = "2026 ğŸš€";
            for(let i=0; i<5; i++) {
                setTimeout(() => createFirework(Math.random()*fwCanvas.width, Math.random()*fwCanvas.height*0.5), i*300);
            }
            setTimeout(() => { cdEl.style.display='none'; isCounting=false; count=3; }, 2000);
        }
        count--;
    }, 1000);
}

// --- 5. MediaPipe é…ç½® ---
const videoElement = document.getElementById('input_video');
const previewCanvas = document.getElementById('video-preview');
const pCtx = previewCanvas.getContext('2d');

const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5 });
hands.onResults(results => {
    // å®æ—¶é¢„è§ˆç»˜åˆ¶
    pCtx.clearRect(0,0,100,75);
    pCtx.drawImage(results.image, 0,0, 100,75);

    if (results.multiHandLandmarks.length > 0) {
        const hand1 = results.multiHandLandmarks[0];
        // æ£€æµ‹å¼ å¼€æ‰‹æŒ (æŒ‡å°– y å°äº å…³èŠ‚ y)
        const isPalm = hand1[8].y < hand1[6].y && hand1[12].y < hand1[10].y;
        if(isPalm) startSequence();

        // éšè—åŠŸèƒ½ï¼šæ¯”å¿ƒæ£€æµ‹ï¼ˆç®€å•é€»è¾‘ï¼šä¸¤åªæ‰‹éƒ½åœ¨ä¸Šæ–¹ä¸”é æ‹¢ï¼‰
        if (results.multiHandLandmarks.length === 2) {
            const hand2 = results.multiHandLandmarks[1];
            if(hand1[8].y < 0.4 && hand2[8].y < 0.4) {
                triggerHeartMemory();
            }
        }
    }
});

const camera = new Camera(videoElement, {
    onFrame: async () => { await hands.send({image: videoElement}); },
    width: 640, height: 480
});
camera.start();

// --- 6. åŠ¨ç”»å¾ªç¯ ---
function animate() {
    ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
    ctx.fillRect(0, 0, fwCanvas.width, fwCanvas.height);
    particles.forEach((p, i) => {
        p.update(); p.draw();
        if(p.alpha <= 0) particles.splice(i, 1);
    });
    tRenderer.render(tScene, tCamera);
    requestAnimationFrame(animate);
}
animate();

// é€‚é…çª—å£
window.addEventListener('resize', () => {
    fwCanvas.width = window.innerWidth; fwCanvas.height = window.innerHeight;
    tCamera.aspect = window.innerWidth/window.innerHeight;
    tCamera.updateProjectionMatrix();
    tRenderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
